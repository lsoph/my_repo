name: Update package version

on: issue_comment

jobs:
  resolve_pr_refs:
    # This job only runs for pull request comments
    name: Resolve PR branches
    if: ${{ github.event.issue.pull_request }}
    runs-on: ubuntu-latest
    outputs:
      target_branch: ${{ steps.refs.outputs.base_ref }}
      source_branch: ${{ steps.refs.outputs.head_ref }}
    steps:
      - uses: eficode/resolve-pr-refs@main
        id: refs
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  is_update_requested:
    name: Is version update requested
    needs: resolve_pr_refs
    if: contains(github.event.comment.body, '$ update')
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.is_requested.outputs.result }}
      version: ${{ steps.is_requested.outputs.type }}
    steps:
      - name: Version update requested
        id: is_requested
        run: |
          result=1

          shopt -s nocasematch

          case "${{ github.event.comment.body }}" in
            "$ update major") version=major;;
            "$ update minor") version=minor;;
            "$ update patch") version=patch;;
            $[[:space:]]update[[:space:]][0-9]+\.[0-9]+\.[0-9]+)
              version=$(echo ${{ github.event.comment.body }} | sed 's|.*[0-9]||');;
            * ) result=0 && version=0;;
          esac

          echo '::set-output name=result::$result'
          echo '::set-output name=version::$version'

          if [ $result==1 ]; then
            echo Version update was requested
            echo Source branch: ${{ needs.resolve_pr_refs.outputs.source_branch }}
            echo Target branch: ${{ needs.resolve_pr_refs.outputs.target_branch }}
          else
            echo Version update was not requested
          fi

  is_organization_member:
    name: TH2 membership check
    needs: is_update_requested
    if: ${{ needs.is_update_requested.outputs.result }}
    runs-on: ubuntu-latest
    outputs:
      is_member: ${{ steps.membership_check.outputs.result }}
    steps:
      - name: Membership check
        id: membership_check
        uses: jamessingleton/is-organization-member@main
        with:
          organization: th2-net
          username: ${{ github.event.issue.user.login }}
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Is member?
        run: |
          result=${{ steps.membership_check.outputs.result }}
          if [ $result == false ]; then
            user=${{ github.event.comment.user.login }}
            echo Either ${user} is not part of the th2-net organization
            echo or ${user} has its Organization Visibility set to Private at
            echo https://github.com/orgs/th2-net/people?query=${user}
            echo
            echo Ensure you change your Organization Visibility to Public and
            echo trigger the test again.
            exit 1
          elif [ $result == true ]; then
            user=${{ github.event.comment.user.login }}
            echo '::set-output name=user_login::$user'
            echo ${user} is part of the th2-net organization
          fi

  update_package_version:
    name: Update package version
    needs: [resolve_pr_refs, is_update_requested, is_organization_member]
    if: ${{ needs.is_organization_member.outputs.is_member }}
    runs-on: ubuntu-latest
    outputs:
      version_target: ${{ steps.target.outputs.package_version }}
      old_version_source: ${{ steps.old_source.outputs.package_version }}
      new_version_source: ${{ steps.new_source.outputs.package_version }}
      versions_check: ${{ steps.check_versions.outputs.result }}
    steps:
      - uses: actions/checkout@v2

      - name: Install Poetry
        uses: snok/install-poetry@v1

      - name: Git configuration
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git pull

      - name: Checkout on target branch
        id: target
        run: |
          git checkout ${{ needs.resolve_pr_refs.outputs.target_branch }}
          echo '::set-output name=package_version::$(poetry version -s)'
          echo Target branch package version: $(poetry version -s)

      - name: Checkout on source branch
        id: old_source
        run: |
          git checkout ${{ needs.resolve_pr_refs.outputs.source_branch }}
          echo '::set-output name=package_version::$(poetry version -s)'

      - name: Update version
        id: new_source
        run: |
          shopt -s nocasematch
          echo Version: ${{ needs.is_update_requested.outputs.version }}
          case '${{ needs.is_update_requested.outputs.version }}' in
            "major") poetry version major;;
            "minor") poetry version minor;;
            "patch") poetry version patch;;
            [0-9]+\.[0-9]+\.[0-9]+) poetry version ${{ needs.is_update_requested.outputs.version }};;
          esac

          echo '::set-output name=package_version::$(poetry version -s)'

      - name: Commit & Push changes
        run: |
          git add pyproject.toml
          git commit -m "[TH2-0] Auto commit. Update package version"
          git push

      - name: Check versions in target and source branches
        id: check_versions
        run: |
          result=true
          if [ ${{ steps.new_source.outputs.package_version }} \< ${{ steps.target.outputs.package_version }} ||
              ${{ steps.new_source.outputs.package_version }} == ${{ steps.target.outputs.package_version }}]; then
            result=false
          fi

          echo '::set-output name=result::$result'

  comment_reply:
    name: Reply to a user's comment
    needs: [is_organization_member, update_package_version]
    runs-on: ubuntu-latest
    steps:
      - name: Create comment body
        id: comment_body
        run: |
          echo Is member: ${{ needs.is_organization_member.outputs.is_member }}

          if [ ${{ needs.is_organization_member.outputs.is_member }}==true &&
              ${{ needs.update_package_version.outputs.versions_check }}==true ]; then
            body='Package version was updated from ${{ needs.update_package_version.outputs.old_version_source }} to
              ${{ needs.update_package_version.outputs.new_version_source }} successfully.'

          elif [ ${{ needs.is_organization_member.outputs.is_member }}==true &&
              ${{ needs.update_package_version.outputs.versions_check }}==false ]; then
            body='Package version was updated from ${{ needs.update_package_version.outputs.old_version_source }} to
              ${{ needs.update_package_version.outputs.new_version_source }}, but package version in target branch
              is ${{ needs.update_package_version.outputs.version_target }}.'

          elif [ ${{ needs.is_organization_member.outputs.is_member }}==false ]; then
            user=${{ github.event.comment.user.login }}
            body="You can update the version only if you are th2 member.
              If you are member, check whether your Organization Visibility set to Public at
              https://github.com/orgs/th2-net/people?query=${user}."
          fi

          echo Comment body: $body
          echo Is member: ${{ needs.is_organization_member.outputs.is_member }}
          echo "::set-output name=body::$(echo $body)"

      - uses: actions/github-script@v5
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '${{ steps.comment_body.outputs.body }}'
            })
