name: Update package version

on: issue_comment

jobs:
  resolve_pr_refs:
    # This job only runs for pull request comments
    name: Resolve PR branches
    if: ${{ github.event.issue.pull_request }}
    runs-on: ubuntu-latest
    outputs:
      target_branch: ${{ steps.refs.outputs.base_ref }}
      source_branch: ${{ steps.refs.outputs.head_ref }}
    steps:
      - uses: eficode/resolve-pr-refs@main
        id: refs
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  is_update_needed:
    name: Is package version update needed
    needs: resolve_pr_refs
    if: |
      contains(github.event.comment.body, 'update major') ||
      contains(github.event.comment.body, 'update minor') ||
      contains(github.event.comment.body, 'update patch')
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.is_needed.outputs.result }}
    steps:
      - name: Version update requested
        id: is_needed
        run: |
          echo Version update requested
          echo Target branch: ${{ needs.resolve_pr_refs.outputs.target_branch }}

          result=false
          if ( needs.resolve_pr_refs.outputs.target_branch=='master' ||
              needs.resolve_pr_refs.outputs.target_branch=='main' ); then
            result=true
          fi

          echo '::set-output name=result::$result'

  is_organization_member:
    name: TH2 membership check
    needs: is_update_needed
    runs-on: ubuntu-latest
    outputs:
      is_member: ${{ steps.membership_check.outputs.result }}
    steps:
      - name: Membership check
        id: membership_check
        uses: jamessingleton/is-organization-member@main
        with:
          organization: th2-net
          username: ${{ github.event.issue.user.login }}
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Is member?
        run: |
          result=${{ steps.membership_check.outputs.result }}
          if [ $result == false ]; then
            user=${{ github.event.comment.user.login }}
            echo Either ${user} is not part of the th2-net organization
            echo or ${user} has its Organization Visibility set to Private at
            echo https://github.com/orgs/th2-net/people?query=${user}
            echo
            echo Ensure you change your Organization Visibility to Public and
            echo trigger the test again.
            exit 1
          elif [ $result == true ]; then
            user=${{ github.event.comment.user.login }}
            echo '::set-output name=user_login::$user'
            echo ${user} is part of the th2-net organization
          fi

#  update_package_version:
#    name: Update package version
#    runs-on: ubuntu-latest
#    steps:

#  push_on_github:
#    name: Commit and push on github
#    runs-on: ubuntu-latest
#    steps:

  comment_reply:
    name: Reply to a user's comment
    needs: [is_update_needed, is_organization_member]
    runs-on: ubuntu-latest
    steps:
      - name: Create comment body
        id: comment_body
        run: |
          if ${{ needs.is_update_needed.outputs.result == true &&
              needs.is_organization_member.outputs.is_member == true}}; then
            body='Update was requested.'

          elif ${{ needs.is_update_needed.outputs.result == false }}; then
            body='You can update the version only if the target branch is master or main.'

          elif ${{ needs.is_organization_member.outputs.is_member == false }}; then
            user=${{ github.event.comment.user.login }}
            body='You can update the version only if you are th2 member.
              If you are member, check if your Organization Visibility set to Public at
              https://github.com/orgs/th2-net/people?query=${user}.'

          fi
          echo '::set-output name=body::$body'

      - uses: actions/github-script@v5
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '${{ steps.comment_body.outputs.body }}'
            })
